\section{アイソメトリック図生成}
\subsection{全体構造}
アイソメ図作成には6D姿勢推定の結果を用いて配管の接続関係を推定する配管ペアマッチングを行い、その結果を基に配管情報の描画を行う。図\ref{fig:f9}にアイソメ図生成の全体構造を示す。
% \begin{figure}[htbt]
%   \centering
%    \includegraphics[height=80mm]{Figure/iso.eps}
%    \caption{アイソメ図生成の全体構造}
%    \label{fig:f9}
% \end{figure}

\subsection{配管ペアマッチング}
アイソメ図作成では、向かい合った配管同士を繋ぎ合わせるため、接続部のペアを特定する必要がある。
配管ペアマッチングは、6D 姿勢推定によって取得された各接続部の位置と姿勢情報をもとに、配管間の接続関係を判断する。
ここでは、例として図\ref{fig:f10}に示すような配管の接続関係を考える。

まず、6D姿勢推定の結果からT字管と曲管の回転行列 $\mathbf{R}_T, \mathbf{R}_C$ と並進ベクトル $\mathbf{t}_T, \mathbf{t}_C$ がそれぞれ与えられているとする。
T字管には接続先となる出口が3つあり、それぞれの方向ベクトルを以下のように定義する。
前方向ベクトルを $\mathbf{d}_{T,f}$、下方向ベクトルを $\mathbf{d}_{T,d}$、上方向ベクトルを $\mathbf{d}_{T,u}$とする。
一方、曲管には出口が2つあり、前方向ベクトルを $\mathbf{d}_{C,f}$、下方向ベクトルを $\mathbf{d}_{C,d}$ とする。

これらの方向ベクトルは、それぞれの回転行列を用いて次のように求める。

\[
\mathbf{d}_{T,f} = \mathbf{R}_T \cdot \mathbf{e}_f, \quad 
\mathbf{d}_{T,u} = \mathbf{R}_T \cdot \mathbf{e}_u, \quad 
\mathbf{d}_{T,d} = \mathbf{R}_T \cdot \mathbf{e}_d
\]
\[
\mathbf{d}_{C,f} = \mathbf{R}_C \cdot \mathbf{e}_f, \quad 
\mathbf{d}_{C,u} = \mathbf{R}_C \cdot \mathbf{e}_u
\]

ここで、$\mathbf{e}_f, \mathbf{e}_u, \mathbf{e}_d$ は基準となる単位ベクトルであり、それぞれ $\mathbf{e}_f = [1, 0, 0]^\mathrm{T}$、$\mathbf{e}_u = [0, 1, 0]^\mathrm{T}$、$\mathbf{e}_d = [0, -1, 0]^\mathrm{T}$ とする。

次に、T字管と曲管の位置を示す並進ベクトルを用いて、両者を結ぶ線分のベクトルを以下のように計算する。
\[
\mathbf{l} = \mathbf{t}_C - \mathbf{t}_T
\]

ここで、$\mathbf{l}$ はT字管から曲管への向きを示すベクトルである。

次に、この線分 $\mathbf{l}$ と各方向ベクトルの間の角度を計算する。ベクトル $\mathbf{a}$ と $\mathbf{b}$ の間の角度 $\theta$ は以下の式で表される。

\[
\cos \theta = \frac{\mathbf{a} \cdot \mathbf{b}}{\|\mathbf{a}\| \|\mathbf{b}\|}
\]

ここで、$\|\mathbf{a}\|$ はベクトル $\mathbf{a}$ のノルムである。この式を用いて以下の角度を計算する。

\[
\theta_{Tf} = \arccos \left( \frac{\mathbf{l} \cdot \mathbf{d}_{T,f}}{\|\mathbf{l}\| \|\mathbf{d}_{T,f}\|} \right)
\]
\[
\theta_{Cf} = \arccos \left( \frac{-\mathbf{l} \cdot \mathbf{d}_{C,f}}{\|\mathbf{l}\| \|\mathbf{d}_{C,f}\|} \right)
\]

ここで、$-\mathbf{l}$ を用いるのは、曲管が線分の逆方向を向いている場合を考慮するためである。

最後に、これらの角度がしきい値 $\theta_{th}$ よりも小さい場合、T字管と曲管は互いに向き合っていると判定する。具体的には以下の条件を満たす場合である。

\[
\theta_{Tf} < \theta_{th} \quad \text{かつ} \quad \theta_{Cf} < \theta_{th}
\]

必要に応じて、T字管の追加の方向ベクトル $\mathbf{d}_{T,d}$ を用いて条件を拡張することも可能である。例えば、以下のような条件を追加する。

\[
\theta_{Td} = \arccos \left( \frac{\mathbf{l} \cdot \mathbf{d}_{T,d}}{\|\mathbf{l}\| \|\mathbf{d}_{T,d}\|} \right), \quad \theta_{Td} < \theta_{th}
\]

以上の方法を用いることで、T字管と曲管が互いに向き合っているかを幾何的に判定することができる。

配管ネットワークの接続関係を効率的に探索するために、深さ優先探索（Depth First Search, DFS）を利用する。本手法では、配管の接続部をグラフ構造として表現し、DFSにより再帰的に全ての接続関係を明らかにする。

まず、配管の接続情報をグラフとして定義する。ここで、配管の接続部をノード、接続情報をエッジとする。グラフ $G$ を以下のように表す。

\[
G = (V, E)
\]

ここで、$V$ は配管や接続部の集合、$E$ は接続情報（エッジ）の集合である。また、ノード $u$ に隣接するノードの集合を $\text{Adj}(u)$ とする。

DFSアルゴリズムでは、最も左端に位置する配管を原点とし、未訪問のノードを探索する。初期化として、訪問済みのノードを記録するための集合 $\text{Visited}$ を空集合とする。

\[
\text{Visited} \gets \emptyset
\]

探索は再帰的に行い、現在のノード $u$ を訪問済みと記録し、隣接ノードを順に確認する。具体的なアルゴリズムは以下のように記述される。

\[
\text{DFS}(u):
\begin{cases}
  \text{Visited} \gets \text{Visited} \cup \{ u \} & (\text{現在のノードを訪問済みにする}) \\
  \text{for } v \in \text{Adj}(u): & (\text{隣接ノードを取得}) \\
  \quad \text{if } v \notin \text{Visited}: & (\text{未訪問なら}) \\
  \quad\quad \text{DFS}(v) & (\text{再帰的に探索を進める})
\end{cases}
\]

グラフ全体の探索を行うために、すべてのノード $u \in V$ に対してDFSを適用する。ただし、既に訪問済みのノードはスキップする。

\[
\text{for } u \in V:
\quad \text{if } u \notin \text{Visited}:
\quad\quad \text{DFS}(u)
\]

本アルゴリズムを配管接続問題に適用する場合、各配管をノードとし、接続関係をエッジとすることで、全ての接続部を網羅的に探索可能である。探索の起点として最も左端に位置する配管を選択し、接続ペアが見つかるたびに記録する。DFSは行き止まりに到達すると探索をバックトラックし、他の経路を探索するため、接続関係全体を効率的に把握できる。

この手法により、複数の配管が複雑に接続されたネットワークにおいても、全ての接続関係を正確に明らかにすることが可能となる。また、探索結果を基にしてアイソメ図を作成するための基盤を構築することができる。



\subsection{配管情報の描画}
配管情報の描画において、アイソメ図における配管間の距離は、配管の並進ベクトル同士の3次元空間上での2点間の距離を算出し、ミリメートル単位で記載する。

配管 \( P_i \) と \( P_j \) の並進ベクトルをそれぞれ \( \mathbf{t}_i = (x_i, y_i, z_i) \) および \( \mathbf{t}_j = (x_j, y_j, z_j) \) とすると、これらの並進ベクトル間の距離 \( d_{ij} \) は次のように計算される。

\[
d_{ij} = \sqrt{(x_j - x_i)^2 + (y_j - y_i)^2 + (z_j - z_i)^2}
\]

この距離 \( d_{ij} \) は、配管間の直線距離を表しており、アイソメ図に記載される距離はミリメートル（mm）単位で表現される。したがって、この距離をそのまま図に記載することになる。

次に、配管間を結ぶ線分を描画する。配管 \( P_i \) と \( P_j \) を結ぶ線分は、並進ベクトル \( \mathbf{t}_i = (x_i, y_i, z_i) \) と \( \mathbf{t}_j = (x_j, y_j, z_j) \) を始点と終点とし、以下のように描画される。

次に、DXF ファイルを分析します。
現在、DXF ファイルの読み取りをサポートするオープン ソース ライブラリが多数あります。
このスキームでは、ezdxf ライブラリ [9] を使用します。ezdxf ライブラリは、DXF バージョンに依存しない Python オープン ソース ライブラリです。
既存の DXF ファイルの読み取りと変更、および新しい DXF ファイルの作成が可能です。
ezdxf ライブラリを使用して DXF ファイルを読み込み、そのモデル空間を取得します。
次に、モデル空間内のすべてのエンティティをトラバースして判断を行い、テキスト コンテンツを含む要素を除外し、特定のグループ コードに従ってテキスト コンテンツや位置座標などの関連情報を抽出します。

