\chapter{仮想環境における大規模配管設備での検証実験}
第4章では実環境においてアイソメ図作成を試みたが、小規模な配管設備での実験であったため、本章では仮想環境において大規模な配管設備でアイソメ図作成を行う。

\section{データセット収集}
\subsection{仮想環境構築}
仮想環境の構築には、Unityを使用する。Unityは、3Dモデルの読み込みやカメラの画像取得など、仮想環境の構築に必要な機能が備わっている。
本検証に用いた大規模配管設備を導入し、RGB画像とDepth画像を取得した。
仮想環境における画像の取得にはカメラの内部パラメータを設定できるため、実環境に用いたセンサのパラメータを設定することが可能である。
図\ref{fig:f1}には、例としてAzure Kinect DKの内部パラメータを指定して取得した大規模配管設備のRGB-D画像を示した。
\begin{figure}[htbt]
    \centering
    \includegraphics[height=55mm]{Figure/ex_sim.eps}
    \caption{仮想環境で取得した大規模配管設備のRGB-D画像}
    \label{fig:f1}
\end{figure}

\subsection{センサモデルの導入}
仮想環境で取得されるDepth画像には実環境に比べてノイズが存在しない。
そのため、実環境におけるセンサノイズをモデル化し、仮想環境に導入することで、より実環境に近い状況を再現する。
本研究におけるDepthの取得にはノイズ無し（Ideal）とAzure Kinect DK（Sensor A）とRealsense D435i（Sensor B）の3つの条件で行った。
センサモデルの取得には、実環境で0.5mから10.0mの範囲で0.5m間隔で測定した距離と実際の距離との標準偏差を求め、その結果を適切な関数で近似した。
図\ref{fig:f2}には、各センサの標準偏差と測定距離の結果をもとにして近似した結果を示した。
\begin{figure}[htbt]
    \centering
    \includegraphics[height=60mm]{Figure/sensor_model.eps}
    \caption{Sensor Aの線形近似結果（左）とSensor Bの指数近似結果（右）}
    \label{fig:f2}
\end{figure}

Sensor Bの場合、測定距離に対して標準偏差がSensor Aに比べると測定距離が10mの地点では標準偏差に約60倍の差がある。
そのため、Sensor BのセンサモデルはSensor Aに比べてノイズが大きく、Depth画像にばらつきが大きく現れることが予想される。

図\ref{fig:f3}に示したセンサモデルを用いて、Depth画像の取得結果を示した。
画像にはノイズを加えたが、目視ではノイズが確認することができなかったが、6D姿勢推定の結果に影響を与える可能性があるため、アイソメ図生成の精度を検証する。
\begin{figure}[htbt]
    \centering
    \includegraphics[height=55mm]{Figure/depth_sim.eps}
    \caption{Sensor AモデルによるDepth画像（左）とSensor BモデルによるDepth画像（右）}
    \label{fig:f3}
\end{figure}

\section{評価指標}
評価指標には第4章で述べた6D姿勢推定の評価指標に加え、アイソメ図の評価指標を導入する。
アイソメ図の評価には、Mean Error Distance（MED）とGenerated Line Count（GLC）の2つの指標が用いられる。
アイソメ図の評価におけるMEDは、生成されたアイソメ図の各線分と正解データの線分との平均距離を求めるものである。
この距離は、各線分における誤差を計算し、その平均値を取ることで算出される。

まず、各線分の距離 $d_i$ は、通常、線分の端点間の直線距離を用いて計算される。
例えば、2つの点 $(x_1, y_1)$ と $(x_2, y_2)$ の間のユークリッド距離は、次のように求められる。

\[
d = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2}
\]

この距離を用いて、生成された線分と正解データの対応する線分との誤差を求め、その平均値を取ることで、MEDが算出される。MEDの数式は次のように表される。

\[
MED = \frac{1}{N} \sum_{i=1}^{N} d_i
\]

ここで、$N$は評価対象となる線分の数を示し、$d_i$は第$i$番目の線分における生成されたアイソメ図の線分と正解データの線分との距離である。
MEDの値が小さいほど、正解データとの線分の誤差が少なく、生成されたアイソメ図の精度が高いと評価できる。

一方、GLCは、生成されたアイソメ図と正解データの対応する線分の本数を示す指標である。
この指標は、生成結果が破綻した場合など、MEDだけでは評価が難しい場合に必要となる。
GLCの値が大きいほど、多くの対応線分が正確に生成されているため、アイソメ図の精度が高いと考えられる。

\section{結果と考察}
6D姿勢推定とアイソメ図生成結果を図\ref{fig:f4}に示す。
6D姿勢推定では3Dバウンディングボックスで正解ボックスを赤色で示し、推定ボックスを青色で示した。
これらが重なればなるほど正確に推定できると言える。
IdealとSensorAの場合、推定ボックスが正解ボックスとほぼ一致していることが確認できる。
一方、SensorBの場合、推定ボックスが正解ボックスと大きくずれている配管が見られた。
また、表5.1に6D姿勢推定の評価結果を示す。
IdealとSensorAの場合、TeeとElbowの両方で100\%の精度が得られているため、評価指標においても姿勢が正確に推定できていることが確認できる。
一方、SensorBの場合、TeeとElbowの両方で精度が低下しており、ADD-sucの平均値では42.5\%となっている。
これは、SensorBのセンサモデルがノイズが大きいため、Depth画像の点群データ推定に問題があり6D姿勢推定の精度が低下したことが原因であると考えられる。
特に、配管の姿勢がカメラ視点から見えづらいような配管の場合は、顕著に精度が低下しているのが確認できる。

続いて、アイソメ図生成結果だが、生成データと正解データの図面の比較では、IdealとSensorAの場合、ほぼ一致していることが確認できる。
6D姿勢推定結果が精度が良いこともあり、配管の接続関係を問題なく把握できている。また、線分のズレがないことから距離の誤差も小さいことが確認できる。
一方、SensorBの場合、生成データと正解データの図面の比較では、多くの線分がズレていることや、線分の数が少ないことが確認できる。
表5.2にアイソメ図生成の評価結果を示す。
IdealとSensorAの場合、MEDの値が約1.0mほどとなっており、GLCの値が100\%ととなっているため、アイソメ図生成の精度が高いことが確認できる。
Sensor Aの場合、MEDの値が約1.32mとなっており、GLCの値が100\%となっているため、このセンサのノイズレベルではアイソメ図生成を正確に行うことを示している。
一方、Sensor Bの場合、MEDの値が約3.85mとなっており、GLCの値が27.7\%となっているため、このセンサのノイズレベルではアイソメ図生成を正確に行うことが難しいことが確認できる。
これは、6D姿勢推定の精度が低いことが原因で、配管の接続関係の推定に問題が生じている。
方向ベクトルの表示結果では、それぞれの配管の3次元空間上の位置は問題ないが、姿勢の結果が違う方向を向いているため、他の接続部とペアになると誤認識してしまうため、誤判定が発生している。
アイソメ図作成結果において線分が少ない理由においては、配管のペアがそもそも見つからない配管が存在したため、地面と設置しているものとされ、その先の配管接続探索のステップをスキップしてしまったためである。

以上の結果より、大規模配管設備においてアイソメ図作成を行うことができたが、センサのノイズレベルが高い場合、アイソメ図生成の精度が低下することが確認できた。
そのため、Depthノイズレベルが高いセンサを使用した場合、アイソメ図が破綻する問題が発生したため、適切な精度を有するセンサの選定が重要であることが分かった。

そのため、
\begin{figure}[htbt]
	\centering
	\includegraphics[width=\textwidth]{Figure/result_all_sim.eps}
	\caption{6D姿勢推定とアイソメ図生成結果}
	\label{fig:f4}
\end{figure}

\begin{table}[htbp]
    \centering
    \caption{6D姿勢推定の評価}
    \setlength{\tabcolsep}{5pt}
    \begin{tabular}{|c|c|c|c|c|c|c|c|c|c|}
        \hline
        & \multicolumn{3}{c|}{Ideal} & \multicolumn{3}{c|}{Sensor A} & \multicolumn{3}{c|}{Sensor B} \\ \hline
         & Tee & Elbow & Mean & Tee & Elbow & Mean & Tee & Elbow & Mean \\ \hline
        ADD-suc & 100.0 & 100.0 & 100.0 & 100.0 & 100.0 & 100.0 & 50.0 & 35.0 & 42.5 \\ \hline
        Prj-5-suc & 100.0 & 100.0 & 100.0 & 100.0 & 100.0 & 100.0 & 66.7 & 85.0 & 75.8 \\ \hline
    \end{tabular}
\end{table}



\begin{table}[htbp]
    \centering
    \caption{アイソメ図生成の評価}
    \setlength{\tabcolsep}{5pt} % 列間のスペース設定
    \begin{tabular}{|p{2.0cm}|>{\centering\arraybackslash}p{1.8cm}|>{\centering\arraybackslash}p{1.8cm}|>{\centering\arraybackslash}p{1.8cm}|}
        \hline
        \raggedright & Ideal & Sensor A & Sensor B \\ \hline
        \raggedright MED[mm] & 1.23 & 1.32 & 3.85 \\ \hline
        \raggedright GLC & 100.0 & 100.0 & 27.7 \\ \hline
    \end{tabular}
\end{table}

