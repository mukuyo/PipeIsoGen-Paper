\chapter{RGB-D画像に基づく配管6D姿勢推定とアイソメトリック図生成}
従来のアイソメ図作成方法では、3次元点群を取得可能なLIDARセンサーを利用して図面を作成していたが、LIDARセンサーは高価であり、一般的な利用にはコスト面での課題があった。
本研究では、LIDARセンサーよりも安価で入手しやすいRGB-Dカメラを活用し、データ収集からアイソメ図作成までを効率的に行うための配管6D姿勢推定手法を提案する。
本章では、RGB-D画像を用いた配管6D姿勢推定およびアイソメ図生成手法について詳細を述べる。


\section{全体構成}
アイソメ図生成の手順は、データ収集、セグメンテーション、姿勢推定、配管接続関係の推定、配管情報の描画の5つのステップに分類される。
データ収集では、RGB-Dカメラを用いて配管の画像データを取得し、セグメンテーションで位置や形状を抽出する。
続いて、得られたデータを基に配管の姿勢情報を推定し、接続関係を特定することで配管構造全体を把握する。
最終的に、推定された配管情報を基にアイソメ図を生成する。


\section{RGB-D画像に基づく配管6D姿勢推定}
RGB-D画像を用いた配管6D姿勢推定手法では、RGB画像とDepth画像を組み合わせることで物体の形状を正確に把握し、高精度な姿勢推定を実現する。
RGB画像からは色情報を、Depth画像からはピクセルごとの距離情報を取得することで、物体の形状を3次元空間で詳細に表現可能となる。
本手法では、配管6D姿勢推定のモデルとしてSAM-6Dを採用し、セグメンテーションと姿勢推定の2段階で処理を行う。

\subsection{検出クラス}
アイソメ図作成には配管の特徴を活かした効率的な手法を提案する.図2.2に一部配管の例を示す.
一般的な配管は両端部分の曲管やT字管などのつなぎ目を除くと直管であるという特徴がある.
そのため,両端の接続部がどの方向を向いているのかを推論できれば向かい合っている接続部同士のペアを見つけられ,その間を直線で結ぶことでアイソメ図を描画することができる.
本研究においては配管全体を認識するのではなく,配管のつなぎ目である曲管及びT字管のみを認識する.

\subsection{インスタンスセグメンテーション}
セグメンテーションは、画像からピクセル単位で対象物体を認識する手法であり、物体検出がバウンディングボックスの取得に留まるのに対し、より正確に物体の形状を特定できる。
RGB-D画像を活用することで、RGB画像からの色情報に加え、Depth画像からの距離情報も利用可能となり、配管の形状を詳細に把握し、姿勢推定の精度向上につなげる。
セグメンテーションを行う際には事前に配管画像のデータセットを用意し、学習を行うことで高い精度のセグメンテーションを実現する。
データセットには画像から接続部の箇所のみを切り取り、ラベル付けを行うことで、セグメンテーションの学習データを準備する。
配管の画像から検出クラスである曲管とT字管を全てセグメンテーションを行い、それぞれの位置や形状を抽出する。

\subsection{姿勢推定}
姿勢推定では、セグメンテーションで得られたそれぞれの配管に対して推定を行い、3次元空間上の位置情報と回転を求める。
姿勢推定には、事前に接続部の3Dモデルを用意することで、セグメンテーションで得られたオブジェクトの形状と照らし合わせることで、正確な姿勢推定を行う。
SAM-6Dによる姿勢推定では、物体表面の点とオブジェクトモデルの点を対応付けるポイントマッチングを用いる。
さらに、視野遮蔽（オクルージョン）が存在する場合でも精度を維持するため、仮想的な点であるバックグラウンドトークンを導入している。
これにより、欠損領域を含むシーンでも正確な姿勢推定を可能にする。



\section{接続関係推定}
アイソメ図を作成するには、接続部のペアを特定し、正確に配管を接続する必要がある。
配管間の接続関係を特定するために、接続部の方向ベクトルを計算し、そのベクトル間の角度差が小さい接続部をペアとして認識する。
曲管では出口が2つあるため2つの方向ベクトルを、T字管では3つの方向ベクトルを算出する。
これらのベクトルの角度差が小さく、かつ距離が最も短い接続部をペアとして認識することで、接続関係を推定する。
ただし、地面に接続している配管のようにペアが存在しない場合には、ペアマッチングを適用しない。

\section{配管経路の探索} 
接続された配管の経路を効率的に探索するため、深さ優先探索（Depth First Search, DFS）アルゴリズムを使用する。
DFSは、グラフ構造内のノードを一つの経路で可能な限り深く進み、行き止まりに達した際に戻って別の経路を探索するアルゴリズムである。
この手法により、すべての接続部を効率的に訪問し、再帰的に探索を進めることが可能となる。
探索の起点は最も左端に位置する配管とし、接続情報に基づいて配管を順次描画する。

\subsection{アイソメ図の描画} 
アイソメ図の描画には、Pythonのezdxfライブラリを使用する。
ezdxfはDXFファイルの作成に特化しており、直線や円弧などの描画が可能である。
配管の寸法情報は、カメラ座標系で取得した3次元位置データを基に計算される。
配管経路探索で得られた接続情報をもとに、ezdxfを用いて正確なアイソメ図を描画する。
この方法により、配管システムの構造を視覚的に表現する図面を効率的に作成することができる。


% \section{RGB画像を用いた配管6D姿勢推定} 


% \subsection{物体検出}
% 本手法では、物体検出にYOLOv8を使用する。
% 一般的な6D姿勢推定モデルであるGen6Dには物体検出機能が内蔵されているが、複数物体を同時に扱うことができない。
% そのため、まずYOLOv8を用いて配管を含む複数の物体を検出することとした。
% YOLOv8の出力は、検出した物体ごとのバウンディングボックス座標およびスケール情報である。これにより、複数の配管を効率的に識別可能とした。

% \subsection{6D姿勢推定}
% 物体検出の結果を基に、Gen6Dを用いて配管の6D姿勢を推定する。
% 具体的には、YOLOv8が出力したバウンディングボックスを基に対象物体の画像を切り取り、これをGen6Dに入力することで姿勢推定を行う。
% Gen6Dは、Selectorを用いて検出領域内の画像から、事前に用意された参照画像と最も類似する画像を選択する。
% この参照画像は姿勢データを持ち、これを基に物体の初期姿勢を取得する仕組みである。

% さらに、6枚の近似視点を持つ画像を選択し、それらの平均と分散を計算することで初期姿勢を補正し、最終的な姿勢を推定する。
% 最終的に得られる6D姿勢は、オブジェクトの位置（X, Y, Z）および姿勢（Yaw, Pitch, Roll）の情報を含む。

% 本手法は、従来の単一物体に限定されていた6D姿勢推定を複数物体に拡張することで、産業用途での応用可能性を大きく向上させている。

% データ収集において、本研究では、RGB-D カメラ(Intel Realsense D435i)を用いて、配管データを収集した。
% RGB-D カメラは、3D レーザースキャナーと比べ、圧倒的に安価である。また、軽量化及び小型化され、複雑な配 管環境に最適だと考えられる。
% RGB-D カメラで収集したデータは、カラー画像(RGB)だけでなく、対象までの 距離、或は深度データ(D)も取得できる。対象までの距離に基づき、三次元点群を得ることができる。
% すなわち、 カラー画像の各ピクセルは、一つの三次元点群に対応するということである。
% データ処理において、本研究では、データ処理と認識を同時に行うという手法を提案した。
% それぞれの深度画像 から得た三次元点群を合併し、配管点群モデルを構築する。一方、深層学習による画像セグメンテーションを行う ことで、予測マップを求める。
% 最後に、データ統合では、配管点群モデルに深層学習での予測マップを付けることで、ラベル付きの配管点群モ デルを得ることができ、三次元配管認識を実現できる。


% \begin{figure}[htbt]
% 	\includegraphics[height=65mm]{flow2.eps}
% 	\caption{RGB-Dカメラを用いた深層学習による配管6D姿勢推定までの手順}
% 	\label{fig:f2}
% \end{figure}




% \section{アイソメ図変換方法}
% アイソメ図作成には配管の特徴を活かした効率的な手法を提案する.図2.2に一部配管の例を示す.
% 一般的な配管は両端部分の曲管やT字管などのつなぎ目を除くと直管であるという特徴がある.そのため,両端の曲管がどの方向を向いているのかを推論できれば向かい合っている曲管のペアを見つけられ,その間を直線で結ぶことで
% アイソメ図を描画することができる.そのため,本研究においては配管全体を認識するのではなく,配管のつなぎ目である曲管及びT字管を物体検出と姿勢推定を用いて推論する.

% \begin{figure}[htbt]
% 	\centering
% 	 \includegraphics[height=55mm]{pipe.eps}
% 	 \caption{配管の検出例}
% 	 \label{fig:f2}
% \end{figure}


% \section{データセット収集}
% 深層学習による認識ネットワークにはデータセットの数量が多いほど精度とロバスト性が向上する.
% それは様々な場面での配管の写真を学習することによってどの環境においても対応できる汎用性が高まることを意味している.本研究使用するデータセットの一部を図3.2に示す.
% 配管には曲管やT字管や直管が含まれており,この画像内の中から曲管とT字管を全て認識できることを目標とする.また,Depth画像の有効性を示すためにテスト画像では
% 暗闇の中に配管を設置したデータセットを用意した.Depth画像は光の影響を受けにくいことから,暗闇の中でも配管を認識できるかを検証する.\\
% 収集したデータはラベリング作業を行う.これは深層学習するにおいての正解データとして,予め画像内のどの部分が曲管又はT字管であるかをアノテーションする必要がある.
% 本研究では配管画像に対して曲管,T字管の二つのクラスに分けてラベリング作業を行った.

% 6D姿勢推定のデータセットにはColmapを使用して点群データを取得する.Colmap2D画像から点群を再構築するために使用されるソフトウェアである.
% この2D画像は異なる視点から撮影された同じオブジェクトの画像を複数枚利用することで3次元情報を復元することができる.
% そのため,本研究では曲管とT字管の周囲をそれぞれ撮影し,Colmapを使用することで点群データを取得した.
% 図3.6では姿勢推定を行った後,得られた出力の評価を行う際に使用する.
% しかし,点群データを取得してもColmapで生成されたデータには距離情報が含まれていないため,別途Depth画像を使用してアイソメ図作成の際に使用しなければいけない.
