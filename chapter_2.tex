\chapter{深層学習による配管6D姿勢推定}

従来のアイソメ図作成方法では、3次元点群を取得可能なLIDARセンサーを利用して図面を作成していた。
しかし、LIDARセンサーは他のセンサーと比較して高価であり、一般的な利用にはコストが課題となっていた。
本研究では、LIDARセンサーよりも安価で入手しやすいRGB-Dカメラを用い、データ収集からアイソメ図作成までを効率的に行うための配管6D姿勢推定手法を提案する。
本章では、RGB画像およびRGB-D画像を用いた6D姿勢推定手法について詳細を述べる。

\section{RGB画像を用いた配管6D姿勢推定} 
RGB画像を用いた深層学習による配管6D姿勢推定の手順は、データ収集、データ処理、認識、データ統合の4つのステップに分類できる。以下に、各ステップについて詳述する。

\subsection{物体検出}
本手法では、物体検出にYOLOv8を使用する。
一般的な6D姿勢推定モデルであるGen6Dには物体検出機能が内蔵されているが、複数物体を同時に扱うことができない。
そのため、まずYOLOv8を用いて配管を含む複数の物体を検出することとした。
YOLOv8の出力は、検出した物体ごとのバウンディングボックス座標およびスケール情報である。これにより、複数の配管を効率的に識別可能とした。

\subsection{6D姿勢推定}
物体検出の結果を基に、Gen6Dを用いて配管の6D姿勢を推定する。
具体的には、YOLOv8が出力したバウンディングボックスを基に対象物体の画像を切り取り、これをGen6Dに入力することで姿勢推定を行う。
Gen6Dは、Selectorを用いて検出領域内の画像から、事前に用意された参照画像と最も類似する画像を選択する。
この参照画像は姿勢データを持ち、これを基に物体の初期姿勢を取得する仕組みである。

さらに、6枚の近似視点を持つ画像を選択し、それらの平均と分散を計算することで初期姿勢を補正し、最終的な姿勢を推定する。
最終的に得られる6D姿勢は、オブジェクトの位置（X, Y, Z）および姿勢（Yaw, Pitch, Roll）の情報を含む。

本手法は、従来の単一物体に限定されていた6D姿勢推定を複数物体に拡張することで、産業用途での応用可能性を大きく向上させている。

\section{RGB-D画像を用いた配管6D姿勢推定} 
RGB-D画像を用いた配管6D姿勢推定も同様に、データ収集、データ処理、認識、データ統合の4つのステップに分けて説明する。
本手法では、セグメンテーションと6D姿勢推定にSAM-6Dを採用している。

\subsection{セグメンテーション}
セグメンテーションは、配管画像をピクセル単位で分類する手法である。
物体検出が物体のバウンディングボックスを取得するのみに留まるのに対し、セグメンテーションでは物体の形状をより正確に特定することが可能である。
RGB-D画像を用いることで、RGB画像からの色情報に加え、Depth画像から取得したピクセルごとの距離情報を参照できる。
この結果、物体の形状を詳細に把握し、精度の高い姿勢推定を実現する。

\subsection{6D姿勢推定}
SAM-6Dによる6D姿勢推定では、物体表面の点とオブジェクトモデルの点を対応付けるポイントマッチングを用いる。
また、オクルージョン（視野遮蔽）が存在する場合でも精度を維持するため、バックグラウンドトークンと呼ばれる仮想的な点を導入している。
これにより、欠損領域に対しても正確に姿勢推定を行うことが可能となる。

SAM-6Dは、高度なセグメンテーション技術とポイントマッチング手法を統合し、従来のRGB画像ベースの手法では対応が難しかった複雑なシーンにも対応可能としている。



% データ収集において、本研究では、RGB-D カメラ(Intel Realsense D435i)を用いて、配管データを収集した。
% RGB-D カメラは、3D レーザースキャナーと比べ、圧倒的に安価である。また、軽量化及び小型化され、複雑な配 管環境に最適だと考えられる。
% RGB-D カメラで収集したデータは、カラー画像(RGB)だけでなく、対象までの 距離、或は深度データ(D)も取得できる。対象までの距離に基づき、三次元点群を得ることができる。
% すなわち、 カラー画像の各ピクセルは、一つの三次元点群に対応するということである。
% データ処理において、本研究では、データ処理と認識を同時に行うという手法を提案した。
% それぞれの深度画像 から得た三次元点群を合併し、配管点群モデルを構築する。一方、深層学習による画像セグメンテーションを行う ことで、予測マップを求める。
% 最後に、データ統合では、配管点群モデルに深層学習での予測マップを付けることで、ラベル付きの配管点群モ デルを得ることができ、三次元配管認識を実現できる。


% \begin{figure}[htbt]
% 	\includegraphics[height=65mm]{flow2.eps}
% 	\caption{RGB-Dカメラを用いた深層学習による配管6D姿勢推定までの手順}
% 	\label{fig:f2}
% \end{figure}




% \section{アイソメ図変換方法}
% アイソメ図作成には配管の特徴を活かした効率的な手法を提案する.図2.2に一部配管の例を示す.
% 一般的な配管は両端部分の曲管やT字管などのつなぎ目を除くと直管であるという特徴がある.そのため,両端の曲管がどの方向を向いているのかを推論できれば向かい合っている曲管のペアを見つけられ,その間を直線で結ぶことで
% アイソメ図を描画することができる.そのため,本研究においては配管全体を認識するのではなく,配管のつなぎ目である曲管及びT字管を物体検出と姿勢推定を用いて推論する.

% \begin{figure}[htbt]
% 	\centering
% 	 \includegraphics[height=55mm]{pipe.eps}
% 	 \caption{配管の検出例}
% 	 \label{fig:f2}
% \end{figure}


% \section{データセット収集}
% 深層学習による認識ネットワークにはデータセットの数量が多いほど精度とロバスト性が向上する.
% それは様々な場面での配管の写真を学習することによってどの環境においても対応できる汎用性が高まることを意味している.本研究使用するデータセットの一部を図3.2に示す.
% 配管には曲管やT字管や直管が含まれており,この画像内の中から曲管とT字管を全て認識できることを目標とする.また,Depth画像の有効性を示すためにテスト画像では
% 暗闇の中に配管を設置したデータセットを用意した.Depth画像は光の影響を受けにくいことから,暗闇の中でも配管を認識できるかを検証する.\\
% 収集したデータはラベリング作業を行う.これは深層学習するにおいての正解データとして,予め画像内のどの部分が曲管又はT字管であるかをアノテーションする必要がある.
% 本研究では配管画像に対して曲管,T字管の二つのクラスに分けてラベリング作業を行った.

% 6D姿勢推定のデータセットにはColmapを使用して点群データを取得する.Colmap2D画像から点群を再構築するために使用されるソフトウェアである.
% この2D画像は異なる視点から撮影された同じオブジェクトの画像を複数枚利用することで3次元情報を復元することができる.
% そのため,本研究では曲管とT字管の周囲をそれぞれ撮影し,Colmapを使用することで点群データを取得した.
% 図3.6では姿勢推定を行った後,得られた出力の評価を行う際に使用する.
% しかし,点群データを取得してもColmapで生成されたデータには距離情報が含まれていないため,別途Depth画像を使用してアイソメ図作成の際に使用しなければいけない.
